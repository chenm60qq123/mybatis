<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <!-- <title>H+ 后台主题UI框架 - 主页</title> -->
  <!--[if lt IE 8]>
    <meta http-equiv="refresh" content="0;ie.html" />
    <![endif]-->
  <link href="../js/plugins/elementUi/index.css" rel="styleSheet">
  <link rel="stylesheet/less" type="text/css" href="./css/act.less" />
<script src="./lib/less/less.js/less.min.js" type="text/javascript"></script>
</head>

<body>
  <div id="app">
    <el-row >
        <el-row>
          <el-button type="primary" icon="el-icon-plus" @click="action('add')">新增</el-button>
          <el-button type="danger" icon="el-icon-delete" @click="action('deleteIn',multipleSelection)">删除</el-button>
          <el-button type="success" icon="el-icon-refresh" @click="freachData('refresh')">刷新</el-button>
        </el-row>
        <el-row justify="center" style="margin-top: 10px;">
          <el-table :data="tableData" style="width: 100%" @selection-change="handleSelectionChange" v-loading="loading"
          element-loading-text="拼命加载中"
          element-loading-spinner="el-icon-loading"
          >
            <el-table-column type="selection" width="55">
            </el-table-column>
            <el-table-column type="index" label="序号" width="80">
            </el-table-column>
            <el-table-column prop="id" label="模板编号" width="180" v-if="false">
            </el-table-column>
            <el-table-column prop="list_id" label="目录编号" width="180" v-if="false">
            </el-table-column>
            <el-table-column prop="template_name" label="模板名称" width="200" >
            </el-table-column>
            <el-table-column prop="template_describe" label="模板描述" >
            </el-table-column>
            <el-table-column fixed="right" label="操作" width="200">
              <template slot-scope="scope">
                <el-button type="primary" icon="el-icon-edit" circle @click="action('update',scope.row)"></el-button>
                <el-button type="danger" icon="el-icon-delete" circle @click="action('delete',scope.row)"></el-button>
              </template>
            </el-table-column>

          </el-table>
          <div style="text-align:center;margin-top: 10px">
            <el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange" :current-page="currentPage"
              :page-sizes="[20,50,100, 200, 300, 400]" :page-size=pageSize layout="total, sizes, prev, pager, next, jumper"
              :total=total>
            </el-pagination>
          </div>
      </el-row>
    </el-row>
    <el-dialog title="" :visible.sync="dialogFlieFormVisible" width="70%" center>
      <el-row :gutter="10" >
        <el-col :span="6" >
              <el-tree
              :data="data4"
              show-checkbox
              node-key="id"
              default-expand-all
              :expand-on-click-node="false">
              <span class="custom-tree-node" slot-scope="{ node, data }" >
                <span  v-if='nodeid!=node.id'>
                    <span :id="nodeid" v-if='nodeid!=node.id'>{{nodeid}}</span>
                    <span class="el-icon-news" @click="" style="margin-left: 20px;display: inline-block"></span>
                    <span class="el-icon-document" @click="addInput(node.id,data)"></span>
                    <span class="el-icon-delete" @click='inputValue=""'></span>
                </span>
                <span v-if='nodeid==node.id'>
                  <input type='text' style="width: 80px" v-model="inputValue" >
                  <span class='el-icon-check' @click='update(1)'></span>
                  <span class='el-icon-close' @click='inputValue=""'></span>
                </span>
              </span>
            </el-tree>
        </el-col>
        <el-col :span="18">
            <el-input
            :rows="25"
            type="textarea"
            placeholder="请输入内容"
            v-model="textarea2">
          </el-input>
        </el-col>
      </el-row>
    </el-dialog>
    <el-dialog title="数据库" :visible.sync="dialogFormVisible" width="40%">
      <el-form :model="insertForm" :inline="false" :rules="rules" ref="insertForm">
        <el-form-item label="模板名称" :label-width="formLabelWidth" prop="template_name">
          <el-input v-model="insertForm.template_name" ></el-input>
        </el-form-item>
        <el-form-item label="模板描述" :label-width="formLabelWidth" prop="template_describe">
          <el-input v-model="insertForm.template_describe" autocomplete="off" type="textarea"
          :rows="4"></el-input>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button type="primary" @click="validateAction('insertForm')">提 交</el-button>
        <el-button @click="dialogFormVisible = false">取 消</el-button>
      </div>
    </el-dialog>
  </div>

  <script src="../js/vue.js"></script>
  <script src="../js/plugins/elementUi/index.js"></script>
  <script src="../js/jquery.min.js"></script>
  <script>
    function update(value){
      console.log(value);
    }

    new Vue({
      el: '#app',
      data() {
        const data = [{
        id: 1,
        label: '一级 1',
        children: [{
          id: 4,
          label: '二级 1-1',
          children: [{
            id: 9,
            label: '三级 1-1-1'
          }, {
            id: 10,
            label: '三级 1-1-2'
          }]
        }]
      }, {
        id: 2,
        label: '一级 2',
        children: [{
          id: 5,
          label: '二级 2-1'
        }, {
          id: 6,
          label: '二级 2-2'
        }]
      }, {
        id: 3,
        label: '一级 3',
        children: [{
          id: 7,
          label: '二级 3-1'
        }, {
          id: 8,
          label: '二级 3-2'
        }]
      }];
        return {
          inputValue:'1',
          nodeid:'3',
          data4: JSON.parse(JSON.stringify(data)),
          loading:false,
          total: 0,
          currentPage: 1,
          pageSize: 20,
          dialogFlieFormVisible:true,
          dialogFormVisible: false,
          method: "",
          formDemo: {
            template_name: null,
            template_describe: null,
          },
          insertForm: {
            template_name: null,
            template_describe: null,
          },
          formLabelWidth: '100px',
          tableData: [],
          multipleSelection: [],
          rules: {
            template_name: [{
              required: true,
              message: '模板名称',
              trigger: 'blur'
            }],

          }

        }
      },
      mounted() {
        this.init();
      },
      methods: {
        addInput(id,data){
         this.nodeid=id;
         console.log(this.nodeid);
        },
        init() {
          this.freachData();
        },
        freachData(value) {
          var that = this;
          that.loading=true;
          $.post("/template/selectByPage", {
            "pageSize": that.pageSize,
            "pageNum": that.currentPage
          }, function (result) {
            that.tableData = result.data.items;
            that.total = result.data.totalNum;
            that.currentPage = result.data.currentPage;
            that.loading=false;
            if(value==='refresh'){
              that.$message({
                      message: "数据刷新成功！",
                      type: 'success'
            });
            }
            
          })
        },
        action(value, row) {
          this.method = value;
          if (value === "add") {
            Object.assign(this.insertForm, this.formDemo);
            this.dialogFormVisible = true;
          } else if (value === "update") {
            this.insertForm = row;
            this.dialogFormVisible = true;
          } else if (value.indexOf("delete") != -1) {
            this.insertForm = row;
            this.submit();
          }

        },
        validateAction(from){
          var that=this;
          this.$refs[from].validate((valid) => {
            if (!valid) {
              that.$message({
                    message: "数据错误！",
                    type: 'error'
              });
            }else{
              that.submit();
            }
          })
        },
        submit(from){
          var that = this;
          $.ajax({
                type: "post",
                url: "/template/" + that.method,
                data: JSON.stringify(that.insertForm),
                contentType: 'application/json',
                dataType: "json",
                success: function (result) {
                  if (result && result.state === "200") {
                    that.$message({
                      message: result.message,
                      type: 'success'
                    });
                    that.dialogFormVisible = false;
                    that.freachData();
                  } else if (result.state === "500") {
                    that.$message({
                      message: result.message,
                      type: 'error'
                    });
                  }

                },
                error: function (result) {
                  that.$message({
                    message: "出现错误！",
                    type: 'error'
                  });
                }

          });
        },
        handleSelectionChange(val) {
          this.multipleSelection = val;
        },
        handleSizeChange(val) {
          this.pageSize = val;
          this.freachData();
        },
        handleCurrentChange(val) {
          this.currentPage = val;
          this.freachData();
        },
        append(data) {
        const newChild = { id: id++, label: 'testtest', children: [] };
        if (!data.children) {
          this.$set(data, 'children', []);
        }
        data.children.push(newChild);
      },

      remove(node, data) {
        const parent = node.parent;
        const children = parent.data.children || parent.data;
        const index = children.findIndex(d => d.id === data.id);
        children.splice(index, 1);
      },

      

      }
    })
  </script>

</body>

</html>